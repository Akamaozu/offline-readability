module.exports = function( noticeboard ){

  var jQuery = require('jquery'),
      api_url = '/api/1';

  noticeboard.once('no-api-token-in-store', 'api:get-api-token-from-server', function(){

    jQuery.get('/api-token', function( token ){

      if( !token ) return;

      store.set( 'api-token', token );

      noticeboard.notify( 'update-app-state', { api_token: api_token }, 'get-api-token' );
      noticeboard.notify( 'api-token-loaded', api_token );
    });
  });

  noticeboard.once('api-token-loaded', 'api:setup-api-integrations', function(){

    jQuery('#main-wrapper').on( 'click', 'a', function( event ){

      if( event.target.host !== window.location.host ) return;

      event.preventDefault();

      return noticeboard.notify('next-page', event.target.pathname);
    });

    noticeboard.watch('get-bookmarks-page', 'api:get-page', function( msg ){

      noticeboard.notify('get-app-state', function( state ){

        var type = msg.notice.type,
            page = msg.notice.page,
            callback = msg.notice.callback;

        jQuery.ajax({

          url: api_url + '/' + type + '/' + page,
          headers: {

            'Authorization': 'Bearer ' + state.api_token
          },

          success: function( content ){

            callback( content );
            noticeboard.notify('bookmarks-page-downloaded', { page: page, type: type, content: content }, 'api:get-page');
          } 
        });
      });
    });

    noticeboard.watch('get-article', 'api:get-article', function( msg ){

      noticeboard.notify('get-app-state', function( state ){

        var article_id = msg.notice.id,
            callback = msg.notice.callback;

        jQuery.ajax({

          url: api_url + '/article/' + article_id,
          headers: {

            'Authorization': 'Bearer ' + state.api_token
          },

          success: function( content ){

            callback( content );
            noticeboard.notify('article-downloaded', { id: article_id, content: content }, 'api:get-article');
          } 
        });
      });
    });
  });
}