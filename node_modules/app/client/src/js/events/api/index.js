module.exports = function( noticeboard ){

  var jQuery = require('jquery'),
      api_url = '/api/1';

  noticeboard.once('no-api-token-in-store', 'get-api-token-from-server', function(){

    jQuery.get('/api-token', function( token ){

      if( !token ) return;

      store.set( 'api-token', token );

      noticeboard.notify( 'update-app-state', { api_token: api_token }, 'get-api-token' );
      noticeboard.notify( 'api-token-loaded', api_token );
    });
  });

  noticeboard.once('api-token-loaded', 'setup-api-integrations', function(){

    jQuery('#main-wrapper').on( 'click', 'a', function( event ){

      if( event.target.host !== window.location.host ) return;

      event.preventDefault();

      var link = event.target.pathname.split('/');

      if( link.length <= 1 ){

        return noticeboard.notify('next-view', { view: 'home' }, 'api:link-interceptor');
      }

      switch( link[1] ){

        case 'bookmarks':

          var filter = link[1],
              page = link[2] || 1;

          return noticeboard.notify('next-view', {view: 'index', view_data: { filter: filter, page: page }}, 'api:link-interceptor');
        break;
      }
    });

    noticeboard.watch('get-bookmarks-page', 'get-page-from-server', function( msg ){

      noticeboard.notify('get-app-state', function( state ){

        var type = msg.notice.type,
            page = msg.notice.page,
            callback = msg.notice.callback;

        jQuery.ajax({

          url: api_url + '/' + type + '/' + page,
          headers: {

            'Authorization': 'Bearer ' + state.api_token
          },

          success: function( content ){

            callback( content );
            noticeboard.notify('bookmarks-page-downloaded', { page: page, type: type, content: content });
          } 
        });
      });
    });
  });
}