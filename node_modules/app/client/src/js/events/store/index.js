module.exports = function( noticeboard ){
  
  var store = require('store');

  if( !store.enabled ) return;

  noticeboard.notify('update-app-state', { local_storage: true }, 'store:bootstrap');
  
  if( !store.get('bookmarks-pages') ) store.set('bookmarks-pages', {});  
  if( !store.get('favorites-pages') ) store.set('favorites-pages', {});  
  if( !store.get('archives-pages') ) store.set('archives-pages', {});

  noticeboard.once('bootstrap-completed', 'get-api-token', function( msg ){

    var api_token = store.get('api-token');

    if( api_token ){

      noticeboard.notify( 'update-app-state', { api_token: api_token }, 'store:get-api-token' );
      noticeboard.notify( 'api-token-loaded', api_token, 'store:get-api-token' );
    }

    else noticeboard.notify('no-api-token-in-store', null, 'store:get-api-token');
  });

  noticeboard.watch('get-bookmarks-page', 'store:get-page', function( msg ){

    var request = msg.notice,
        pages = store.get( request.type + '-pages');

    if( !request.page ) request.page = 1;

    if( !pages || !pages[ request.page ] ) return;

    request.callback( pages[ request.page ] );
  });

  noticeboard.watch('bookmarks-page-downloaded', 'store:save-page', function( msg ){

    var data = msg.notice,
        page = data.page,
        type = data.type,
        content = data.content,
        current_pages = store.get( type + '-pages' );

    if( !current_pages[ page ] ){

      current_pages[ page ] = content;
      store.set( type + '-pages', current_pages );

      return noticeboard.notify('bookmarks-pages-updated');
    }

    if( JSON.stringify( content ) === JSON.stringify( current_pages[ page ] ) ) return;

    current_pages[ page ] = content;
    store.set( type + '-pages', current_pages );

    return noticeboard.notify('bookmarks-pages-updated');
  });
}