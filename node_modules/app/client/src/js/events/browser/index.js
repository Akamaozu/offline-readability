module.exports = function( noticeboard ){
  
  var PushState = require( "properjs-pushstate" ),
      history = new PushState();
  
  noticeboard.once('bootstrap-completed', 'browser:redirect-after-bootstrap', function( msg ){

    noticeboard.notify('get-app-state', function( state ){

      if( !state.local_storage && !state.api_token ) return;

      if( state.last_view ) return;

      switch( window.location.pathname ){

        case '/':
          
          noticeboard.notify('next-page', '/bookmarks', 'browser:redirect-after-bootstrap');

        break;
      }
    });
  });

  noticeboard.watch('next-page', 'browser:update-address-bar', function( msg ){
    
    noticeboard.once('new-view-rendered', 'browser:update-address-bar', function( msg ){

      var view_url = msg.notice.url;
          
      history.push( view_url );
    });
  });

  history.on('popstate', function( url ){

    noticeboard.notify('render-url', url, 'browser:history');
  });
}